(**
 * Machine IR.
 * A pseudo-x86-64 machine IR, to be generated by the instruction selection pass.
 *)

open! Core

type sym = Label.sym
type label = Label.t
type vreg = Reg.vreg
type preg = Reg.preg
type reg = Reg.reg

type mem_addr =
  | Static of label
  | Dynamic of
      { base : reg
      ; offset : Int32.t
      }

type operand =
  | Imm32 of Int32.t
  | Reg of reg
  | Addr of mem_addr

type program =
  { data : sym list
  ; code : block list
  }

and block =
  { label : label
  ; data : liveness list
  }

and liveness =
  { instr : minstr
  ; uses : reg Hash_set.t
  ; defs : reg Hash_set.t
  ; clobbers : reg Hash_set.t
  }

and minstr =
  | Mov of
      { dst : operand
      ; src : operand
      }
  | Lea of
      { dst : reg
      ; src : operand
      }
  | Add of
      { dst : reg
      ; src : operand
      }
  | Sub of
      { dst : reg
      ; src : operand
      }
  | IMul of
      { dst : reg
      ; src : operand
      }
  | IDiv of operand
  | Cdq
  | Neg of reg
  | Not of reg
  | Call of operand
  | Jmp of label
  | Cmp of
      { dst : reg
      ; src : operand
      }
  | Je of label
  | Jne of label
  | Jl of label
  | Jle of label
  | Jg of label
  | Jge of label
  | Sete of reg
  | Setne of reg
  | Setl of reg
  | Setle of reg
  | Setg of reg
  | Setge of reg
  | Push of reg
  | Pop of reg
  | Ret
